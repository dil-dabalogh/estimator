AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Estimation Tool API

Globals:
  Function:
    Timeout: 900
    MemorySize: 2048
    Runtime: python3.11

# These Parameters are set during deployment and automatically become Lambda environment variables
# Set them via: sam deploy --guided (interactive)
# Or via: sam deploy --parameter-overrides LLMProvider=bedrock BedrockRegion=us-west-2 ...
# Or via: samconfig.toml configuration file
Parameters:
  AllowedIPRanges:
    Type: String
    Description: "Comma-separated list of IP ranges allowed to access the API (CIDR notation, e.g., 203.0.113.0/24,198.51.100.0/24). Use 0.0.0.0/0 to allow all."
    Default: "0.0.0.0/0"
  
  LLMProvider:
    Type: String
    Default: openai
    AllowedValues:
      - openai
      - bedrock
  
  OpenAIApiKey:
    Type: String
    NoEcho: true
    Default: ""
  
  OpenAIModel:
    Type: String
    Default: gpt-4
  
  BedrockRegion:
    Type: String
    Default: us-west-2
    Description: AWS region for Bedrock (optional - defaults to Lambda's region if not specified)
  
  BedrockModel:
    Type: String
    Default: anthropic.claude-3-sonnet-20240229-v1:0
  
  AtlassianURL:
    Type: String
  
  AtlassianEmail:
    Type: String
  
  AtlassianToken:
    Type: String
    NoEcho: true

Resources:
  # Lambda Authorizer for IP-based access control
  IPAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend
      Handler: authorizer.handler
      Runtime: python3.11
      Timeout: 10
      Environment:
        Variables:
          ALLOWED_IP_RANGES: !Ref AllowedIPRanges

  EstimationApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      Auth:
        Authorizers:
          IPAuthorizer:
            AuthorizerType: REQUEST
            AuthorizerPayloadFormatVersion: "2.0"
            EnableSimpleResponses: true
            FunctionArn: !GetAtt IPAuthorizerFunction.Arn
            Identity:
              ReauthorizeEvery: 300
        DefaultAuthorizer: IPAuthorizer
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowMethods:
          - GET
          - POST
          - OPTIONS
        AllowHeaders:
          - "*"
  
  # Grant API Gateway permission to invoke authorizer
  AuthorizerInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IPAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${EstimationApi}/*"

  EstimationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../backend
      Handler: lambda_handler.handler
      # Parameters (set during deployment) are mapped to Lambda environment variables here
      Environment:
        Variables:
          LLM_PROVIDER: !Ref LLMProvider              # From Parameter: LLMProvider
          OPENAI_API_KEY: !Ref OpenAIApiKey           # From Parameter: OpenAIApiKey
          OPENAI_MODEL: !Ref OpenAIModel              # From Parameter: OpenAIModel
          BEDROCK_REGION: !Ref BedrockRegion          # From Parameter: BedrockRegion (optional - falls back to Lambda's AWS_REGION)
          BEDROCK_MODEL: !Ref BedrockModel            # From Parameter: BedrockModel
          ATLASSIAN_URL: !Ref AtlassianURL            # From Parameter: AtlassianURL
          ATLASSIAN_USER_EMAIL: !Ref AtlassianEmail   # From Parameter: AtlassianEmail
          ATLASSIAN_API_TOKEN: !Ref AtlassianToken    # From Parameter: AtlassianToken
      Events:
        ApiEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref EstimationApi
            Path: /{proxy+}
            Method: ANY

Outputs:
  EstimationApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${EstimationApi}.execute-api.${AWS::Region}.amazonaws.com"

